import React, { useState, useEffect, useMemo } from 'react';
import { 
  ShoppingCart, 
  CheckSquare, 
  Calendar as CalendarIcon, 
  Plus, 
  Trash2, 
  Check, 
  Users, 
  ExternalLink,
  Clock,
  Home,
  UserPlus,
  Smile,
  AlertCircle,
  Edit2,
  Save,
  X,
  Filter,
  ArrowRight,
  WifiOff
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  doc, 
  onSnapshot, 
  serverTimestamp 
} from 'firebase/firestore';

// --- Environment Safety Check ---
let app, auth, db, appId;
let isEnvironmentValid = false;

try {
  if (typeof __firebase_config !== 'undefined' && typeof __app_id !== 'undefined') {
    const firebaseConfig = JSON.parse(__firebase_config);
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
    appId = __app_id;
    isEnvironmentValid = true;
  } else {
    console.warn("Firebase config missing - running in fallback/demo mode");
  }
} catch (e) {
  console.error("Failed to initialize Firebase:", e);
}

// --- Utilities ---
const AVATAR_COLORS = [
  'bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-green-500', 
  'bg-emerald-500', 'bg-teal-500', 'bg-cyan-500', 'bg-blue-500', 
  'bg-indigo-500', 'bg-violet-500', 'bg-purple-500', 'bg-fuchsia-500', 
  'bg-pink-500', 'bg-rose-500'
];

const getBorderColor = (bgClass) => {
  if (!bgClass) return 'border-slate-200';
  return bgClass.replace('bg-', 'border-');
};

const formatDate = (timestamp) => {
  if (!timestamp) return '';
  // Handle both Firestore timestamp and raw Date objects (for demo mode)
  const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
  return date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' });
};

const App = () => {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('shopping'); 
  const [loading, setLoading] = useState(true);

  // Data states
  const [shoppingList, setShoppingList] = useState([]);
  const [tasks, setTasks] = useState([]);
  const [events, setEvents] = useState([]);
  const [members, setMembers] = useState([]);

  // Inputs & Filters
  const [newItem, setNewItem] = useState('');
  const [newTask, setNewTask] = useState('');
  const [newTaskDueDate, setNewTaskDueDate] = useState('');
  const [newTaskAssignee, setNewTaskAssignee] = useState(''); 
  const [newEvent, setNewEvent] = useState({ title: '', date: '' });
  const [newMemberName, setNewMemberName] = useState('');
  const [selectedColor, setSelectedColor] = useState(AVATAR_COLORS[0]);
  
  const [taskFilter, setTaskFilter] = useState('all'); 

  // Edit State
  const [editingTaskId, setEditingTaskId] = useState(null);
  const [editFormData, setEditFormData] = useState({ text: '', dueDate: '', assignedTo: '' });

  // Derived State
  const currentUserProfile = useMemo(() => {
    if (!user || !members.length) return null;
    return members.find(m => m.uid === user.uid);
  }, [user, members]);

  const visibleTasks = useMemo(() => {
    if (taskFilter === 'all') return tasks;
    if (!user) return [];
    return tasks.filter(t => t.assignedTo === user.uid);
  }, [tasks, taskFilter, user]);

  const calendarItems = useMemo(() => {
    const formattedEvents = events.map(e => ({
      ...e,
      type: 'event',
      dateObj: new Date(e.date)
    }));

    const formattedTasks = tasks
      .filter(t => t.dueDate && !t.completed)
      .map(t => ({
        ...t,
        type: 'task',
        title: t.text, 
        date: t.dueDate,
        dateObj: new Date(t.dueDate)
      }));

    return [...formattedEvents, ...formattedTasks].sort((a, b) => a.dateObj - b.dateObj);
  }, [events, tasks]);

  // --- Authentication & Init ---
  useEffect(() => {
    if (!isEnvironmentValid) {
      // Fallback for demo mode/missing env
      setLoading(false);
      setUser({ uid: 'demo-user' });
      setMembers([{ id: 'm1', uid: 'demo-user', name: 'Gość', color: 'bg-blue-500' }]);
      setShoppingList([{ id: 's1', text: 'Przykładowy produkt (Tryb Demo)', completed: false, createdBy: 'demo-user' }]);
      return;
    }

    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth error:", error);
        setLoading(false);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // --- Data Listeners ---
  useEffect(() => {
    if (!isEnvironmentValid || !user) return;

    const subscribe = (collectionName, setter) => {
      const q = collection(db, 'artifacts', appId, 'public', 'data', collectionName);
      return onSnapshot(q, (snapshot) => {
        const data = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setter(data);
      });
    };

    const unsubShopping = subscribe('family_shopping', setShoppingList);
    const unsubTasks = subscribe('family_tasks', setTasks);
    const unsubEvents = subscribe('family_events', setEvents);
    const unsubMembers = subscribe('family_members', setMembers);

    return () => {
      unsubShopping();
      unsubTasks();
      unsubEvents();
      unsubMembers();
    };
  }, [user]);

  // --- Handlers ---

  const addItem = async (collectionName, data) => {
    if (!isEnvironmentValid) return; // No-op in demo mode
    if (!user) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', collectionName), {
        ...data,
        createdAt: serverTimestamp(),
        createdBy: user.uid
      });
    } catch (e) { console.error(e); }
  };

  const toggleComplete = async (collectionName, id, currentStatus) => {
    if (!isEnvironmentValid) return;
    if (!user) return;
    const ref = doc(db, 'artifacts', appId, 'public', 'data', collectionName, id);
    
    const isNowCompleted = !currentStatus;
    const updateData = { completed: isNowCompleted };

    if (collectionName === 'family_tasks') {
      if (isNowCompleted) {
        updateData.completedBy = user.uid;
      } else {
        updateData.completedBy = null; 
      }
    }

    await updateDoc(ref, updateData);
  };

  const deleteItem = async (collectionName, id) => {
    if (!isEnvironmentValid) return;
    const ref = doc(db, 'artifacts', appId, 'public', 'data', collectionName, id);
    await deleteDoc(ref);
  };

  // Editing Logic
  const startEditing = (task) => {
    setEditingTaskId(task.id);
    setEditFormData({
      text: task.text,
      dueDate: task.dueDate || '',
      assignedTo: task.assignedTo || ''
    });
  };

  const cancelEditing = () => {
    setEditingTaskId(null);
    setEditFormData({ text: '', dueDate: '', assignedTo: '' });
  };

  const saveEditing = async (taskId) => {
    if (!isEnvironmentValid) {
       setEditingTaskId(null);
       return;
    }
    if (!editFormData.text.trim()) return;
    
    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'family_tasks', taskId);
    await updateDoc(ref, {
      text: editFormData.text,
      dueDate: editFormData.dueDate,
      assignedTo: editFormData.assignedTo || null
    });
    
    setEditingTaskId(null);
  };

  // Form Wrappers
  const handleAddShopping = (e) => {
    e.preventDefault();
    if (!newItem.trim()) return;
    if (!isEnvironmentValid) { alert("W trybie demo nie można dodawać danych."); return; }
    addItem('family_shopping', { text: newItem, completed: false });
    setNewItem('');
  };

  const handleAddTask = (e) => {
    e.preventDefault();
    if (!newTask.trim()) return;
    if (!isEnvironmentValid) { alert("W trybie demo nie można dodawać danych."); return; }
    addItem('family_tasks', { 
      text: newTask, 
      completed: false,
      dueDate: newTaskDueDate,
      assignedTo: newTaskAssignee || null 
    });
    setNewTask('');
    setNewTaskDueDate('');
    setNewTaskAssignee('');
  };

  const handleAddEvent = (e) => {
    e.preventDefault();
    if (!newEvent.title.trim() || !newEvent.date) return;
    if (!isEnvironmentValid) { alert("W trybie demo nie można dodawać danych."); return; }
    addItem('family_events', { title: newEvent.title, date: newEvent.date });
    setNewEvent({ title: '', date: '' });
  };

  const handleAddMember = (e) => {
    e.preventDefault();
    if (!newMemberName.trim()) return;
    if (!isEnvironmentValid) { alert("W trybie demo nie można dodawać danych."); return; }
    addItem('family_members', { 
      name: newMemberName, 
      color: selectedColor,
      uid: user.uid
    });
    setNewMemberName('');
    setSelectedColor(AVATAR_COLORS[Math.floor(Math.random() * AVATAR_COLORS.length)]);
  };

  const renderAvatar = (uid, size = 'sm', showName = false) => {
    const member = members.find(m => m.uid === uid);
    const sizeClasses = size === 'sm' ? 'w-6 h-6 text-[10px]' : 'w-8 h-8 text-xs';
    if (!member) return null;
    return (
      <div className="flex items-center gap-2">
        <div className={`${member.color} ${sizeClasses} rounded-full flex items-center justify-center text-white font-bold shadow-sm border border-white flex-shrink-0`} title={member.name}>
          {member.name.charAt(0).toUpperCase()}
        </div>
        {showName && <span className="text-xs font-medium text-slate-600">{member.name}</span>}
      </div>
    );
  };

  if (loading) return <div className="flex items-center justify-center h-screen text-blue-600">Ładowanie...</div>;

  return (
    <div className="flex flex-col h-screen bg-slate-50 font-sans overflow-hidden">
      
      {/* Environment Warning Banner */}
      {!isEnvironmentValid && (
        <div className="bg-amber-100 text-amber-800 text-xs p-2 text-center border-b border-amber-200 flex items-center justify-center gap-2">
          <WifiOff className="w-4 h-4" />
          <span><strong>Tryb Demo:</strong> Aplikacja otwarta poza edytorem. Brak połączenia z bazą danych.</span>
        </div>
      )}
      
      {/* Header */}
      <header className="bg-blue-600 text-white p-4 pt-safe-top shadow-md flex justify-between items-center z-10">
        <div className="flex items-center gap-2">
          <Home className="w-6 h-6" />
          <div>
            <h1 className="text-lg font-bold tracking-wide leading-tight">Nasza Rodzina</h1>
            {currentUserProfile && (
              <p className="text-xs text-blue-200 font-medium">Cześć, {currentUserProfile.name}!</p>
            )}
          </div>
        </div>
        <div className="flex items-center gap-2">
           {!currentUserProfile && activeTab !== 'family' && isEnvironmentValid && (
             <button onClick={() => setActiveTab('family')} className="bg-white/20 hover:bg-white/30 px-2 py-1 rounded text-xs animate-pulse">
               Dołącz
             </button>
           )}
           <div className="bg-blue-500 px-3 py-1 rounded-full text-xs font-medium flex items-center gap-1">
             <Users className="w-3 h-3" />
             {members.length}
           </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="flex-1 overflow-y-auto p-4 pb-24 scroll-smooth">
        
        {/* SHOPPING */}
        {activeTab === 'shopping' && (
          <div className="space-y-4 max-w-md mx-auto">
            <div className="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 sticky top-0 z-10">
              <form onSubmit={handleAddShopping} className="flex gap-2">
                <input type="text" value={newItem} onChange={(e) => setNewItem(e.target.value)} placeholder="Co kupić?" className="flex-1 bg-slate-50 border-none rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none text-slate-700" />
                <button type="submit" className="bg-blue-600 text-white p-3 rounded-xl hover:bg-blue-700 shadow-blue-200 shadow-md"><Plus className="w-6 h-6" /></button>
              </form>
            </div>
            <div className="space-y-2">
              {shoppingList.length === 0 && (
                <div className="text-center text-slate-400 py-10"><ShoppingCart className="w-12 h-12 mx-auto mb-2 opacity-20" /><p>Koszyk pusty</p></div>
              )}
              {shoppingList.map((item) => (
                <div key={item.id} className={`flex items-center p-3 bg-white rounded-xl shadow-sm border-l-4 transition-all ${item.completed ? 'border-emerald-400 bg-slate-50/50' : 'border-blue-400'}`}>
                  <button onClick={() => toggleComplete('family_shopping', item.id, item.completed)} className={`w-6 h-6 mr-3 rounded-full border-2 flex items-center justify-center transition-colors flex-shrink-0 ${item.completed ? 'bg-emerald-400 border-emerald-400' : 'border-slate-300'}`}>
                    {item.completed && <Check className="w-4 h-4 text-white" />}
                  </button>
                  <div className="flex-1 min-w-0 mr-2">
                    <span className={`text-base block truncate ${item.completed ? 'text-slate-400 line-through' : 'text-slate-800'}`}>{item.text}</span>
                  </div>
                  <div className="flex items-center gap-2 flex-shrink-0">
                    {renderAvatar(item.createdBy)}
                    <button onClick={() => deleteItem('family_shopping', item.id)} className="text-slate-300 hover:text-red-500"><Trash2 className="w-5 h-5" /></button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* TASKS */}
        {activeTab === 'tasks' && (
          <div className="space-y-4 max-w-md mx-auto">
            <div className="flex justify-end mb-2">
               <div className="bg-slate-200 p-1 rounded-lg inline-flex items-center text-xs font-medium">
                  <button onClick={() => setTaskFilter('all')} className={`px-3 py-1.5 rounded-md transition-all ${taskFilter === 'all' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Wszystkie</button>
                  <button onClick={() => setTaskFilter('mine')} className={`px-3 py-1.5 rounded-md transition-all flex items-center gap-1 ${taskFilter === 'mine' ? 'bg-white text-violet-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Users className="w-3 h-3" /> Moje</button>
               </div>
            </div>
            <div className="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 sticky top-0 z-10">
              <form onSubmit={handleAddTask} className="flex flex-col gap-3">
                <input type="text" value={newTask} onChange={(e) => setNewTask(e.target.value)} placeholder="Nowe zadanie..." className="w-full bg-slate-50 border-none rounded-xl px-4 py-3 focus:ring-2 focus:ring-violet-500 outline-none text-slate-700" />
                <div className="flex gap-2">
                  <input type="date" value={newTaskDueDate} onChange={(e) => setNewTaskDueDate(e.target.value)} className="bg-slate-50 border-none rounded-xl px-3 py-2 text-xs text-slate-600 focus:ring-2 focus:ring-violet-500 outline-none w-1/3" />
                  <select value={newTaskAssignee} onChange={(e) => setNewTaskAssignee(e.target.value)} className="bg-slate-50 border-none rounded-xl px-3 py-2 text-xs text-slate-600 focus:ring-2 focus:ring-violet-500 outline-none flex-1">
                    <option value="">Dla wszystkich</option>
                    {members.map(m => (<option key={m.uid} value={m.uid}>{m.name}</option>))}
                  </select>
                  <button type="submit" className="bg-violet-600 text-white px-4 py-2 rounded-xl hover:bg-violet-700 shadow-violet-200 shadow-md font-bold text-sm"><Plus className="w-5 h-5" /></button>
                </div>
              </form>
            </div>
            <div className="space-y-3">
              {visibleTasks.length === 0 && (
                <div className="text-center py-8 text-slate-400"><Filter className="w-10 h-10 mx-auto mb-2 opacity-20" /><p>{taskFilter === 'mine' ? 'Brak zadań przypisanych do Ciebie.' : 'Brak zadań.'}</p></div>
              )}
              {visibleTasks.map((task) => {
                if (editingTaskId === task.id) {
                  return (
                    <div key={task.id} className="bg-white p-3 rounded-xl shadow-lg border-2 border-violet-200 animate-in fade-in zoom-in-95">
                       <div className="flex items-center justify-between mb-2 border-b border-slate-100 pb-2">
                          <span className="text-xs font-bold text-violet-600 uppercase flex items-center gap-1"><Edit2 className="w-3 h-3" /> Edytuj zadanie</span>
                          <button onClick={cancelEditing} className="text-slate-400 hover:text-slate-600"><X className="w-4 h-4" /></button>
                       </div>
                       <div className="space-y-2">
                          <input type="text" value={editFormData.text} onChange={(e) => setEditFormData({...editFormData, text: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm" />
                          <div className="flex gap-2">
                             <input type="date" value={editFormData.dueDate} onChange={(e) => setEditFormData({...editFormData, dueDate: e.target.value})} className="bg-slate-50 border border-slate-200 rounded-lg px-2 py-2 text-xs w-1/3" />
                             <select value={editFormData.assignedTo} onChange={(e) => setEditFormData({...editFormData, assignedTo: e.target.value})} className="bg-slate-50 border border-slate-200 rounded-lg px-2 py-2 text-xs flex-1">
                                <option value="">Dla wszystkich</option>
                                {members.map(m => (<option key={m.uid} value={m.uid}>{m.name}</option>))}
                              </select>
                          </div>
                          <button onClick={() => saveEditing(task.id)} className="w-full bg-violet-600 text-white py-1.5 rounded-lg text-xs font-bold hover:bg-violet-700 flex items-center justify-center gap-1"><Save className="w-3 h-3" /> Zapisz</button>
                       </div>
                    </div>
                  );
                }
                const completer = members.find(m => m.uid === task.completedBy);
                let containerClass = "bg-white border-l-4 border-slate-200";
                let completedBadge = null;
                if (task.completed && completer) {
                  containerClass = `bg-white border-l-4 ${getBorderColor(completer.color)} bg-opacity-50`;
                  completedBadge = (<div className={`text-[10px] px-2 py-1 rounded-full ${completer.color} text-white bg-opacity-90 flex items-center gap-1 ml-2`}><Check className="w-3 h-3" />{completer.name}</div>);
                } else if (task.completed) {
                  containerClass = "bg-slate-50 border-l-4 border-slate-300 opacity-60";
                } else if (task.assignedTo) {
                  containerClass = "bg-white border-l-4 border-violet-400";
                }
                return (
                  <div key={task.id} className={`p-3 rounded-xl shadow-sm transition-all ${containerClass} group relative`}>
                    <div className="flex items-start gap-3">
                       <button onClick={() => toggleComplete('family_tasks', task.id, task.completed)} className={`mt-1 w-6 h-6 rounded border-2 flex items-center justify-center transition-colors flex-shrink-0 ${task.completed ? 'bg-slate-300 border-slate-300' : 'border-slate-300 hover:border-violet-400'}`}>
                        {task.completed && <Check className="w-4 h-4 text-white" />}
                      </button>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-start justify-between mb-1 pr-6">
                          <span className={`font-medium break-words ${task.completed ? 'text-slate-400 line-through' : 'text-slate-800'}`}>{task.text}</span>
                        </div>
                        <div className="flex flex-wrap items-center gap-2 mt-2">
                          {!task.completed && task.assignedTo && (<div className="flex items-center gap-1 bg-violet-50 px-2 py-1 rounded-lg border border-violet-100"><span className="text-[10px] text-violet-400 uppercase font-bold">Dla:</span>{renderAvatar(task.assignedTo, 'sm', true)}</div>)}
                          {completedBadge}
                          {task.dueDate && !task.completed && (<span className="text-[10px] px-2 py-1 rounded border bg-amber-50 text-amber-700 border-amber-100 flex items-center gap-1 font-medium"><AlertCircle className="w-3 h-3" />{new Date(task.dueDate).toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' })}</span>)}
                        </div>
                      </div>
                    </div>
                    <div className="absolute top-2 right-2 flex gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                      {!task.completed && (<button onClick={() => startEditing(task)} className="p-1.5 text-slate-300 hover:text-blue-500 bg-white/50 rounded hover:bg-white"><Edit2 className="w-4 h-4" /></button>)}
                      <button onClick={() => deleteItem('family_tasks', task.id)} className="p-1.5 text-slate-300 hover:text-red-500 bg-white/50 rounded hover:bg-white"><Trash2 className="w-4 h-4" /></button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* CALENDAR */}
        {activeTab === 'calendar' && (
          <div className="space-y-6 max-w-md mx-auto">
             <div className="bg-gradient-to-r from-blue-500 to-blue-600 p-4 rounded-2xl text-white shadow-lg shadow-blue-200 flex justify-between items-center">
              <div><h2 className="font-bold text-lg">Google Calendar</h2><p className="text-blue-100 text-xs">Zsynchronizuj z telefonem</p></div>
              <a href="https://calendar.google.com/" target="_blank" rel="noreferrer" className="bg-white/20 p-2 rounded-lg hover:bg-white/30"><ExternalLink className="w-5 h-5" /></a>
            </div>
            <div>
              <h3 className="font-bold text-slate-700 mb-3 px-2 flex items-center gap-2"><CalendarIcon className="w-5 h-5 text-amber-500" /> Kalendarz rodziny</h3>
              <div className="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 mb-4">
                <form onSubmit={handleAddEvent} className="flex flex-col gap-2">
                  <input type="text" value={newEvent.title} onChange={(e) => setNewEvent({...newEvent, title: e.target.value})} placeholder="Nazwa wydarzenia..." className="w-full bg-slate-50 border-none rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-amber-500 outline-none" />
                  <div className="flex gap-2">
                    <input type="date" value={newEvent.date} onChange={(e) => setNewEvent({...newEvent, date: e.target.value})} className="flex-1 bg-slate-50 border-none rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-amber-500 outline-none text-slate-600" />
                    <button type="submit" className="bg-amber-500 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-amber-600">Dodaj</button>
                  </div>
                </form>
              </div>
              <div className="space-y-3">
                {calendarItems.length === 0 && (<div className="text-center py-8 text-slate-400"><CalendarIcon className="w-10 h-10 mx-auto mb-2 opacity-20" /><p>Brak nadchodzących wydarzeń lub zadań.</p></div>)}
                {calendarItems.map((item) => {
                  const isTask = item.type === 'task';
                  const borderClass = isTask ? 'border-violet-400' : 'border-amber-400';
                  const iconColor = isTask ? 'text-violet-500' : 'text-amber-500';
                  return (
                    <div key={item.id} className={`flex bg-white p-3 rounded-xl border-l-4 ${borderClass} shadow-sm relative group items-center`}>
                      <div className="flex flex-col justify-center items-center px-3 border-r border-slate-100 mr-3 text-slate-600 min-w-[3.5rem]">
                        <span className="text-[10px] font-bold uppercase">{new Date(item.date).toLocaleString('pl-PL', { month: 'short' })}</span>
                        <span className="text-lg font-bold">{new Date(item.date).getDate()}</span>
                      </div>
                      <div className="flex-1 cursor-pointer" onClick={() => isTask && setActiveTab('tasks')}>
                        <div className="flex items-center gap-1.5">
                          {isTask ? (<CheckSquare className={`w-3 h-3 ${iconColor}`} />) : (<Clock className={`w-3 h-3 ${iconColor}`} />)}
                          <span className={`text-[10px] font-bold uppercase ${iconColor}`}>{isTask ? 'Zadanie' : 'Wydarzenie'}</span>
                        </div>
                        <h4 className="font-bold text-slate-800 text-sm">{item.title}</h4>
                        {isTask && (<div className="flex items-center gap-1 mt-0.5 text-xs text-slate-400"><span className="flex items-center gap-1">Przejdź do zadań <ArrowRight className="w-3 h-3" /></span></div>)}
                      </div>
                       <div className="flex items-center gap-2">
                          {renderAvatar(item.createdBy)}
                          <button onClick={() => deleteItem(isTask ? 'family_tasks' : 'family_events', item.id)} className="text-slate-300 hover:text-red-400"><Trash2 className="w-4 h-4" /></button>
                       </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}

        {/* FAMILY TAB */}
        {activeTab === 'family' && (
          <div className="space-y-6 max-w-md mx-auto">
            <div className="text-center py-4"><h2 className="text-2xl font-bold text-slate-800">Domownicy</h2><p className="text-slate-500 text-sm">Dodaj siebie, aby inni widzieli, co dodajesz.</p></div>
            {!currentUserProfile && isEnvironmentValid && (
              <div className="bg-white p-5 rounded-2xl shadow-lg border-2 border-blue-100 relative overflow-hidden">
                <div className="absolute top-0 right-0 bg-blue-500 text-white text-[10px] px-2 py-1 rounded-bl-lg font-bold">WYMAGANE</div>
                <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2"><UserPlus className="w-5 h-5 text-blue-500" /> Kim jesteś?</h3>
                <form onSubmit={handleAddMember} className="space-y-4">
                  <input type="text" value={newMemberName} onChange={(e) => setNewMemberName(e.target.value)} placeholder="Twoje imię..." className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-medium text-slate-800 placeholder:text-slate-400" />
                  <div>
                    <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Wybierz kolor awatara</label>
                    <div className="flex flex-wrap gap-2">
                      {AVATAR_COLORS.map(c => (<button key={c} type="button" onClick={() => setSelectedColor(c)} className={`w-8 h-8 rounded-full transition-transform ${c} ${selectedColor === c ? 'scale-125 ring-2 ring-offset-2 ring-slate-300 shadow-md' : 'opacity-70 hover:opacity-100'}`} />))}
                    </div>
                  </div>
                  <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-colors">Stwórz Profil</button>
                </form>
              </div>
            )}
            <div className="grid grid-cols-2 gap-3">
              {members.map((member) => (
                <div key={member.id} className={`bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-3 ${member.uid === user?.uid ? 'ring-2 ring-blue-400 ring-offset-1' : ''}`}>
                  <div className={`${member.color} w-10 h-10 rounded-full flex items-center justify-center text-white font-bold shadow-sm`}>{member.name.charAt(0).toUpperCase()}</div>
                  <div className="overflow-hidden"><h4 className="font-bold text-slate-800 truncate">{member.name}</h4>{member.uid === user?.uid && (<span className="text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded font-medium">Ty</span>)}</div>
                </div>
              ))}
            </div>
            {currentUserProfile && (<div className="bg-emerald-50 text-emerald-700 p-4 rounded-xl text-sm border border-emerald-100 flex gap-3 items-start"><Smile className="w-5 h-5 flex-shrink-0 mt-0.5" /><p>Jesteś zalogowany jako <strong>{currentUserProfile.name}</strong>.</p></div>)}
          </div>
        )}
      </main>

      {/* Nav */}
      <nav className="bg-white border-t border-slate-200 pb-safe-bottom px-2 py-2 flex justify-around items-center shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20">
        {[
          { id: 'shopping', icon: ShoppingCart, label: 'Zakupy', color: 'text-blue-600', bg: 'bg-blue-50' },
          { id: 'tasks', icon: CheckSquare, label: 'Zadania', color: 'text-violet-600', bg: 'bg-violet-50' },
          { id: 'calendar', icon: CalendarIcon, label: 'Kalendarz', color: 'text-amber-600', bg: 'bg-amber-50' },
          { id: 'family', icon: Users, label: 'Rodzina', color: 'text-pink-600', bg: 'bg-pink-50' },
        ].map((item) => (
           <button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex flex-col items-center p-2 rounded-xl transition-all duration-300 min-w-[64px] ${activeTab === item.id ? `${item.color} -translate-y-2 ${item.bg} font-bold shadow-sm` : 'text-slate-400 hover:text-slate-600'}`}>
            <item.icon className={`w-6 h-6 mb-1 ${activeTab === item.id ? 'fill-current opacity-20' : ''}`} />
            <span className="text-[10px]">{item.label}</span>
          </button>
        ))}
      </nav>
    </div>
  );
};

export default App;